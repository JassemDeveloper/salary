<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title> Simple Salary Calculator  </title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root { --radius: 16px; }

    body{
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Tahoma, Arial, sans-serif;
    }

    .app-shell{ max-width: 1100px; }
    .card{ border-radius: var(--radius); }
    .card-header{
      border-top-left-radius: var(--radius);
      border-top-right-radius: var(--radius);
      background: #fff;
    }

    /* Tabs: scroll on phones */
    .nav-tabs{
      flex-wrap: nowrap;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }
    .nav-tabs .nav-link{ white-space: nowrap; }

    /* Tap targets */
    .form-control, .form-select, .btn{ min-height: 44px; }
    .btn-sm{ min-height: 40px; }

    /* Focus */
    :focus-visible{
      outline: 3px solid rgba(13,110,253,.35);
      outline-offset: 2px;
      border-radius: 10px;
    }

    .result-box{ border-radius: 14px; }
    .result-box .badge{ font-size: .9rem; }

    /* Sticky mobile actions */
    .sticky-actions{
      position: sticky;
      bottom: 0;
      z-index: 1020;
      background: rgba(248,249,250,.92);
      backdrop-filter: blur(8px);
      border-top: 1px solid rgba(0,0,0,.08);
      padding: .75rem;
      border-bottom-left-radius: var(--radius);
      border-bottom-right-radius: var(--radius);
      margin: 0 -1.5rem -1.5rem;
    }
    @media (min-width: 992px){
      .sticky-actions{
        position: static;
        margin: 0;
        padding: 0;
        border-top: 0;
        background: transparent;
        backdrop-filter:none;
      }
    }

    .table thead th{ white-space: nowrap; }
    .table-responsive{ border-radius: 12px; border: 1px solid rgba(0,0,0,.08); }

    .helper{ color:#6c757d; }

    /* RTL/LTR spacing fixes */
    html[dir="rtl"] .me-1{ margin-left: .25rem !important; margin-right: 0 !important; }
    html[dir="rtl"] .me-2{ margin-left: .5rem !important; margin-right: 0 !important; }
    html[dir="rtl"] .ms-2{ margin-right: .5rem !important; margin-left: 0 !important; }

    html[dir="ltr"] .me-1{ margin-right: .25rem !important; margin-left: 0 !important; }
    html[dir="ltr"] .me-2{ margin-right: .5rem !important; margin-left: 0 !important; }
    html[dir="ltr"] .ms-2{ margin-left: .5rem !important; margin-right: 0 !important; }

    .toast-container{ z-index: 2000; }
  </style>
</head>

<body class="bg-light">
<div class="container py-3 py-md-5 app-shell">
  <div class="row justify-content-center">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header p-3 p-md-4">
          <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div>
              <h1 class="h4 mb-1" id="appTitle" data-i18n="appTitle">أدوات الرواتب</h1>
              <p class="mb-0 helper" id="appSubtitle" data-i18n="appSubtitle">حساب سريع للربع، الزيادة السنوية، و SAIP.</p>
            </div>

            <div class="d-flex flex-wrap align-items-center gap-2">
              <button id="copyActiveBtn" class="btn btn-outline-primary btn-sm" type="button" data-i18n="copyBtn">نسخ النتيجة</button>

              <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" role="switch" id="rtlToggle" checked>
                <label class="form-check-label small" for="rtlToggle" id="rtlLabel" data-i18n="rtlLabel">العربية / RTL</label>
              </div>
            </div>
          </div>
        </div>

        <div class="card-body p-3 p-md-4">
          <!-- Tabs -->
          <ul class="nav nav-tabs" id="salaryTabs" role="tablist" aria-label="أقسام أدوات الرواتب">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="checker-tab" data-bs-toggle="tab" data-bs-target="#checker"
                      type="button" role="tab" aria-controls="checker" aria-selected="true" data-i18n="tabQuarter">
                فحص الربع
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="increase-tab" data-bs-toggle="tab" data-bs-target="#increase"
                      type="button" role="tab" aria-controls="increase" aria-selected="false" data-i18n="tabIncrease">
                الزيادة السنوية
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="saip-tab" data-bs-toggle="tab" data-bs-target="#saip"
                      type="button" role="tab" aria-controls="saip" aria-selected="false" data-i18n="tabSaip">
                SAIP
              </button>
            </li>
          </ul>

          <div class="tab-content pt-3 pt-md-4" id="salaryTabsContent">

            <!-- TAB 1 -->
            <div class="tab-pane fade show active" id="checker" role="tabpanel" aria-labelledby="checker-tab" tabindex="0">
              <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
                <h2 class="h5 mb-0" id="t1Title" data-i18n="t1Title">فحص الربع للراتب</h2>
                <span class="badge text-bg-light border" id="t1Badge" data-i18n="t1Badge">GC 6–17</span>
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-4">
                  <label class="form-label" for="grade" id="t1GradeLabel" data-i18n="gradeLabel">الدرجة (GC)</label>
                  <select id="grade" class="form-select" aria-required="true"></select>
                </div>

                <div class="col-12 col-md-5">
                  <label class="form-label" for="salaryDisplay" id="t1SalaryLabel" data-i18n="salaryLabel">الراتب</label>

                  <input id="salaryDisplay"
                         type="text"
                         class="form-control"
                         data-i18n-placeholder="salaryPlaceholder"
                         placeholder="مثال: 25,000"
                         inputmode="numeric"
                         autocomplete="off"
                         aria-describedby="salaryHelp">

                  <input id="salary" type="hidden" value="">

                  <div id="salaryHelp" class="form-text" data-i18n="salaryHelp">أرقام فقط (ريال). سيتم تنسيق الرقم تلقائياً أثناء الكتابة.</div>
                </div>

                <div class="col-12 col-md-3 d-none d-lg-grid">
                  <button id="checkBtn" class="btn btn-primary" type="button" data-i18n="checkBtn">تحقق</button>
                </div>
              </div>

              <div class="sticky-actions d-lg-none mt-3">
                <div class="d-grid gap-2">
                  <button id="checkBtnMobile" class="btn btn-primary btn-lg" type="button" data-i18n="checkBtn">تحقق</button>
                  <div class="d-flex gap-2">
                    <button id="resetCheckerMobile" class="btn btn-outline-danger w-50" type="button" data-i18n="resetBtn">إعادة ضبط</button>
                    <button class="btn btn-outline-secondary w-50"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#salaryTable"
                            aria-controls="salaryTable"
                            aria-expanded="false"
                            data-i18n="toggleSalaryTable">
                      الجدول
                    </button>
                  </div>
                </div>
              </div>

              <div class="d-none d-lg-flex gap-2 mt-3">
                <button id="resetChecker" class="btn btn-outline-danger" type="button" data-i18n="resetBtn">إعادة ضبط</button>
                <button class="btn btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#salaryTable"
                        aria-controls="salaryTable"
                        aria-expanded="false"
                        data-i18n="showSalaryTable">
                  عرض جدول الرواتب
                </button>
              </div>

              <hr class="my-4">
              <div id="result" class="alert d-none result-box" role="status" aria-live="polite"></div>

              <div id="salaryTable" class="collapse mt-3">
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-dark">
                      <tr>
                        <th data-i18n="thGc">GC</th>
                        <th data-i18n="thQ1">0–25%</th>
                        <th data-i18n="thQ2">25–50%</th>
                        <th data-i18n="thQ3">50–75%</th>
                        <th data-i18n="thQ4">75–100%</th>
                      </tr>
                    </thead>
                    <tbody id="salaryTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB 2 -->
            <div class="tab-pane fade" id="increase" role="tabpanel" aria-labelledby="increase-tab" tabindex="0">
              <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
                <h2 class="h5 mb-0" id="t2Title" data-i18n="t2Title">حاسبة الزيادة السنوية</h2>
                <span class="badge text-bg-light border" id="t2Badge" data-i18n="t2Badge">ترقية + سقف + مبلغ مقطوع</span>
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-2">
                  <label class="form-label" for="incGrade" data-i18n="gradeLabel">الدرجة (GC)</label>
                  <select id="incGrade" class="form-select" aria-required="true"></select>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label" for="incSalaryDisplay" data-i18n="currentSalaryLabel">الراتب الحالي</label>

                  <input id="incSalaryDisplay"
                         type="text"
                         class="form-control"
                         data-i18n-placeholder="salaryPlaceholder"
                         placeholder="مثال: 25,000"
                         inputmode="numeric"
                         autocomplete="off">

                  <input id="incSalary" type="hidden" value="">
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label" for="incRating" data-i18n="ratingLabel">تقييم الأداء</label>
                  <select id="incRating" class="form-select" aria-required="true"></select>
                </div>

                <!-- NEW: Rate year choice -->
                <div class="col-12 col-md-2">
                  <label class="form-label" for="incRateYear" data-i18n="rateYearLabel">سنة النسبة</label>
                  <select id="incRateYear" class="form-select" aria-required="true"></select>
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label" for="incPromotion" data-i18n="promotionLabel">ترقية؟</label>
                  <select id="incPromotion" class="form-select"></select>
                </div>

                <div class="col-12 col-md-2 d-none d-lg-grid">
                  <button id="calcIncreaseBtn" class="btn btn-success" type="button" data-i18n="calcBtn">احسب</button>
                </div>
              </div>

              <div class="alert alert-light border mt-3 mb-0" role="note">
                <div class="fw-semibold mb-1" data-i18n="rulesTitle">القواعد (ملخص)</div>
                <ul class="mb-0 small" id="rulesList"></ul>
              </div>

              <div class="sticky-actions d-lg-none mt-3">
                <div class="d-grid gap-2">
                  <button id="calcIncreaseBtnMobile" class="btn btn-success btn-lg" type="button" data-i18n="calcBtn">احسب</button>
                  <div class="d-flex gap-2">
                    <button id="resetIncreaseMobile" class="btn btn-outline-danger w-50" type="button" data-i18n="resetBtn">إعادة ضبط</button>
                    <button class="btn btn-outline-secondary w-50"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#increaseTable"
                            aria-controls="increaseTable"
                            aria-expanded="false"
                            data-i18n="showIncreaseTableMobile">
                      جدول النسب
                    </button>
                  </div>
                  <button class="btn btn-outline-secondary"
                          type="button"
                          data-bs-toggle="collapse"
                          data-bs-target="#promoTable"
                          aria-controls="promoTable"
                          aria-expanded="false"
                          data-i18n="showPromoTableMobile">
                    جدول نسب الترقية
                  </button>
                </div>
              </div>

              <div class="d-none d-lg-flex gap-2 flex-wrap mt-3">
                <button id="resetIncrease" class="btn btn-outline-danger" type="button" data-i18n="resetBtn">إعادة ضبط</button>
                <button class="btn btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#increaseTable"
                        aria-controls="increaseTable"
                        aria-expanded="false"
                        data-i18n="showIncreaseTable">
                  عرض جدول نسب الزيادة السنوية
                </button>
                <button class="btn btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#promoTable"
                        aria-controls="promoTable"
                        aria-expanded="false"
                        data-i18n="showPromoTable">
                  عرض جدول نسب الترقية
                </button>
              </div>

              <hr class="my-4">
              <div id="incResult" class="alert d-none result-box" role="status" aria-live="polite"></div>

              <div id="increaseTable" class="collapse mt-3">
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-dark">
                      <tr>
                        <th data-i18n="thRating">التقييم</th>
                        <th data-i18n="thQuarter1">الربع 1</th>
                        <th data-i18n="thQuarter2">الربع 2</th>
                        <th data-i18n="thQuarter3">الربع 3</th>
                        <th data-i18n="thQuarter4">الربع 4</th>
                      </tr>
                    </thead>
                    <tbody id="increaseTableBody"></tbody>
                  </table>
                </div>
              </div>

              <div id="promoTable" class="collapse mt-3">
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle mb-0">
                    <thead class="table-dark">
                      <tr>
                        <th data-i18n="thType">النوع</th>
                        <th data-i18n="thQuarter1">الربع 1</th>
                        <th data-i18n="thQuarter2">الربع 2</th>
                        <th data-i18n="thQuarter3">الربع 3</th>
                        <th data-i18n="thQuarter4">الربع 4</th>
                      </tr>
                    </thead>
                    <tbody id="promoTableBody"></tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- TAB 3 -->
            <div class="tab-pane fade" id="saip" role="tabpanel" aria-labelledby="saip-tab" tabindex="0">
              <div class="d-flex align-items-start justify-content-between flex-wrap gap-2 mb-2">
                <h2 class="h5 mb-0" data-i18n="t3Title">حاسبة مكافأة SAIP</h2>
                <span class="badge text-bg-light border" data-i18n="t3Badge">يدعم الحد الأدنى للمحمّي</span>
              </div>

              <div class="row g-3">
                <div class="col-12 col-md-2">
                  <label class="form-label" for="saipGrade" data-i18n="gradeLabel">الدرجة (GC)</label>
                  <select id="saipGrade" class="form-select" aria-required="true"></select>
                </div>

                <div class="col-12 col-md-4">
                  <label class="form-label" for="saipSalaryDisplay" data-i18n="salaryLabel">الراتب</label>

                  <input id="saipSalaryDisplay"
                         type="text"
                         class="form-control"
                         data-i18n-placeholder="salaryPlaceholder"
                         placeholder="مثال: 25,000"
                         inputmode="numeric"
                         autocomplete="off">

                  <input id="saipSalary" type="hidden" value="">
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label" for="saipRating" data-i18n="ratingLabelShort">التقييم</label>
                  <select id="saipRating" class="form-select" aria-required="true"></select>
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label" for="saipProtected" data-i18n="protectedLabel">محمي؟</label>
                  <select id="saipProtected" class="form-select"></select>
                </div>

                <div class="col-12 col-md-2">
                  <label class="form-label" for="saipCompanyFactor" data-i18n="companyFactorLabel">عامل الشركة</label>
                  <input id="saipCompanyFactor"
                         type="number"
                         class="form-control"
                         data-i18n-placeholder="companyFactorPlaceholder"
                         placeholder="مثال: 1.0"
                         min="0"
                         step="0.01"
                         inputmode="decimal"
                         value="1"
                         aria-required="true">
                </div>

                <div class="col-12 d-none d-lg-grid mt-2">
                  <button id="saipCalcBtn" class="btn btn-dark" type="button" data-i18n="calcSaipBtn">احسب SAIP</button>
                </div>
              </div>

              <div class="alert alert-light border mt-3 mb-0" role="note">
                <div class="fw-semibold" data-i18n="saipEquationTitle">معادلة المكافأة</div>
                <div class="small" id="saipEquationText"></div>
              </div>

              <div class="sticky-actions d-lg-none mt-3">
                <div class="d-grid gap-2">
                  <button id="saipCalcBtnMobile" class="btn btn-dark btn-lg" type="button" data-i18n="calcSaipBtn">احسب SAIP</button>
                  <div class="d-flex gap-2">
                    <button id="resetSaipMobile" class="btn btn-outline-danger w-50" type="button" data-i18n="resetBtn">إعادة ضبط</button>
                    <button class="btn btn-outline-secondary w-50"
                            type="button"
                            data-bs-toggle="collapse"
                            data-bs-target="#saipTables"
                            aria-controls="saipTables"
                            aria-expanded="false"
                            data-i18n="showFactorsMobile">
                      العوامل
                    </button>
                  </div>
                </div>
              </div>

              <div class="d-none d-lg-flex gap-2 mt-3">
                <button id="resetSaip" class="btn btn-outline-danger" type="button" data-i18n="resetBtn">إعادة ضبط</button>
                <button class="btn btn-outline-secondary"
                        type="button"
                        data-bs-toggle="collapse"
                        data-bs-target="#saipTables"
                        aria-controls="saipTables"
                        aria-expanded="false"
                        data-i18n="showFactors">
                  عرض عوامل SAIP
                </button>
              </div>

              <hr class="my-4">
              <div id="saipResult" class="alert d-none result-box" role="status" aria-live="polite"></div>

              <div id="saipTables" class="collapse mt-3">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="table-responsive">
                      <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-dark">
                          <tr><th data-i18n="saipGradeRange">نطاق الدرجة</th><th data-i18n="saipGradeFactor">عامل الدرجة</th></tr>
                        </thead>
                        <tbody>
                          <tr><td data-i18n="saipGc610">GC 6–10</td><td>1.5</td></tr>
                          <tr><td data-i18n="saipGc1114">GC 11–14</td><td>1.8</td></tr>
                          <tr><td data-i18n="saipGc15p">GC 15+</td><td>2.4</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="col-12 col-md-6">
                    <div class="table-responsive">
                      <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-dark">
                          <tr><th data-i18n="thRating">التقييم</th><th data-i18n="saipRatingFactor">عامل التقييم</th></tr>
                        </thead>
                        <tbody>
                          <tr><td>S</td><td>1.5</td></tr>
                          <tr><td>E+</td><td>1.25</td></tr>
                          <tr><td>E</td><td>1.0</td></tr>
                          <tr><td>M</td><td>0.75</td></tr>
                          <tr><td>D</td><td data-i18n="saipDNote">0 (إلا إذا انطبق حد المحمي)</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div class="col-12">
                    <div class="table-responsive">
                      <table class="table table-sm table-striped align-middle mb-0">
                        <thead class="table-dark">
                          <tr><th data-i18n="saipProtectedFloorTitle">حد المحمي (فقط عند Rating=D و Protected=Yes)</th><th data-i18n="saipFloorFactor">عامل الحد</th></tr>
                        </thead>
                        <tbody>
                          <tr><td data-i18n="saipGc610">GC 6–10</td><td>1.0</td></tr>
                          <tr><td data-i18n="saipGc1114">GC 11–14</td><td>1.6</td></tr>
                          <tr><td data-i18n="saipGc15p">GC 15+</td><td>2.0</td></tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                </div>
              </div>
            </div><!-- /saip -->
          </div><!-- /tabs -->
        </div>

        <!-- ✅ NEW: Disclaimer section (bilingual via i18n) -->
        <div class="card-footer bg-white border-top">
          <div class="small text-secondary" id="disclaimerText" data-i18n-html="disclaimerHtml"></div>
        </div>

      </div>

      <p class="text-secondary small mt-3 mb-0" data-i18n="accessibilityNote">
        سهولة الوصول: النتائج تُعلن لقارئات الشاشة، والمدخلات محسنة للهواتف.
      </p>
    </div>
  </div>
</div>

<!-- Toasts -->
<div class="toast-container position-fixed top-0 end-0 p-3">
  <div id="appToast" class="toast align-items-center text-bg-dark border-0" role="status" aria-live="polite" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toastBody">تم</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* =========================
   DATA (كما هي)
========================= */
const salaryBands = {
  6:{min:6695,max:12700,quarters:[{name:"Q1",min:6695,max:8196},{name:"Q2",min:8197,max:9698},{name:"Q3",min:9699,max:11199},{name:"Q4",min:11200,max:12700}]},
  7:{min:7695,max:14615,quarters:[{name:"Q1",min:7695,max:9425},{name:"Q2",min:9426,max:11155},{name:"Q3",min:11156,max:12885},{name:"Q4",min:12886,max:14615}]},
  8:{min:8850,max:16810,quarters:[{name:"Q1",min:8850,max:10840},{name:"Q2",min:10841,max:12830},{name:"Q3",min:12831,max:14820},{name:"Q4",min:14821,max:16810}]},
  9:{min:10175,max:19330,quarters:[{name:"Q1",min:10175,max:12464},{name:"Q2",min:12465,max:14753},{name:"Q3",min:14754,max:17041},{name:"Q4",min:17042,max:19330}]},
  10:{min:11700,max:22235,quarters:[{name:"Q1",min:11700,max:14334},{name:"Q2",min:14335,max:16968},{name:"Q3",min:16969,max:19601},{name:"Q4",min:19602,max:22235}]},
  11:{min:13525,max:29310,quarters:[{name:"Q1",min:13525,max:17471},{name:"Q2",min:17472,max:21418},{name:"Q3",min:21419,max:25364},{name:"Q4",min:25365,max:29310}]},
  12:{min:16230,max:33445,quarters:[{name:"Q1",min:16230,max:20534},{name:"Q2",min:20535,max:24838},{name:"Q3",min:24839,max:29141},{name:"Q4",min:29142,max:33445}]},
  13:{min:18835,max:38800,quarters:[{name:"Q1",min:18835,max:23826},{name:"Q2",min:23827,max:28818},{name:"Q3",min:28819,max:33809},{name:"Q4",min:33810,max:38800}]},
  14:{min:23740,max:48895,quarters:[{name:"Q1",min:23740,max:30029},{name:"Q2",min:30030,max:36318},{name:"Q3",min:36319,max:42606},{name:"Q4",min:42607,max:48895}]},
  15:{min:29665,max:61140,quarters:[{name:"Q1",min:29665,max:37534},{name:"Q2",min:37535,max:45403},{name:"Q3",min:45404,max:53271},{name:"Q4",min:53272,max:61140}]},
  16:{min:37780,max:77855,quarters:[{name:"Q1",min:37780,max:47799},{name:"Q2",min:47800,max:57818},{name:"Q3",min:57819,max:67836},{name:"Q4",min:67837,max:77855}]},
  17:{min:42405,max:87385,quarters:[{name:"Q1",min:42405,max:53650},{name:"Q2",min:53651,max:64895},{name:"Q3",min:64896,max:76140},{name:"Q4",min:76141,max:87385}]}
};

/* NEW: two-year rate sets + "unsure" option */
const increaseRatesByYear = {
  current: {
    "S":  { q1: 0.087, q2: 0.073, q3: 0.054, q4: 0.032 },
    "E+": { q1: 0.073, q2: 0.062, q3: 0.046, q4: 0.036 },
    "E":  { q1: 0.054, q2: 0.045, q3: 0.033, q4: 0.019 },
    "M":  { q1: 0.033, q2: 0.027, q3: 0.016, q4: 0.009 }
  },
  // عدّل هذه القيم إذا كانت نسب "السنة الماضية" مختلفة
  previous: {
    "S":  { q1: 0.072, q2: 0.063, q3: 0.053, q4: 0.039 },
    "E+": { q1: 0.064, q2: 0.056, q3: 0.042, q4: 0.033 },
    "E":  { q1: 0.058, q2: 0.049, q3: 0.035, q4: 0.022 },
    "M":  { q1: 0.034, q2: 0.029, q3: 0.019, q4: 0.012 }
  }
};

const promotionRates = { q1: 0.09, q2: 0.07, q3: 0.05, q4: 0.05 };

/* =========================
   Helpers
========================= */
const fmt = n => Number(n).toLocaleString("en-US");
const sar = n => `${fmt(n)} ${t("sar")}`;
const fmtPct = x => (x * 100).toFixed(1) + "%";
const roundTo5 = n => Math.round(n / 5) * 5;

function toast(msg){
  document.getElementById("toastBody").textContent = msg;
  const t = new bootstrap.Toast(document.getElementById("appToast"), { delay: 1600 });
  t.show();
}

function show(elId, type, html){
  const r = document.getElementById(elId);
  r.className = `alert alert-${type} result-box`;
  r.innerHTML = html;
  r.classList.remove("d-none");
  r.setAttribute("tabindex","-1");
  r.focus({preventScroll:false});
}

function hide(elId){
  const r = document.getElementById(elId);
  r.classList.add("d-none");
  r.innerHTML = "";
}

function badge(text,type){
  return `<span class="badge bg-${type} me-1 mb-1">${text}</span>`;
}

function clamp01(x){ return Math.min(1, Math.max(0, x)); }

/* =========================
   Money input: format-as-you-type + raw value hidden
========================= */
function parseNumericText(s){
  if(typeof s !== "string") return NaN;
  const cleaned = s.replace(/[^\d]/g, "");
  if(cleaned === "") return NaN;
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}

function setMoneyInput(displayId, rawId, rawValue){
  const display = document.getElementById(displayId);
  const raw = document.getElementById(rawId);
  if(!Number.isFinite(rawValue) || rawValue < 0){
    display.value = "";
    raw.value = "";
    return;
  }
  display.value = fmt(rawValue);
  raw.value = String(rawValue);
}

function wireMoneyInput(displayId, rawId, onChange){
  const display = document.getElementById(displayId);
  const raw = document.getElementById(rawId);

  function sync(){
    const n = parseNumericText(display.value);
    if(Number.isFinite(n) && n >= 0){
      raw.value = String(n);
      const caretAtEnd = (display.selectionStart === display.value.length);
      display.value = fmt(n);
      if(caretAtEnd){
        display.setSelectionRange(display.value.length, display.value.length);
      }
    } else {
      raw.value = "";
    }
    if(typeof onChange === "function") onChange();
  }

  display.addEventListener("input", sync);
  display.addEventListener("blur", sync);

  display.addEventListener("paste", (e)=>{
    const txt = (e.clipboardData || window.clipboardData).getData("text");
    const n = parseNumericText(txt);
    e.preventDefault();
    if(Number.isFinite(n) && n >= 0){
      display.value = fmt(n);
      raw.value = String(n);
      if(typeof onChange === "function") onChange();
    }
  });
}

function readNumberFromHidden(id){
  const v = Number(document.getElementById(id).value);
  return Number.isFinite(v) ? v : NaN;
}

/* =========================
   LocalStorage persistence
========================= */
const STORAGE_KEY = "salaryTools:v4_bilingual";

function loadState(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}"); }
  catch{ return {}; }
}

function saveState(partial){
  const curr = loadState();
  const next = { ...curr, ...partial };
  localStorage.setItem(STORAGE_KEY, JSON.stringify(next));
}

function persistAllInputs(){
  const state = {
    rtl: document.documentElement.dir === "rtl",
    lang: document.documentElement.lang || "ar",

    checker: {
      grade: document.getElementById("grade").value || "",
      salary: document.getElementById("salary").value || ""
    },
    increase: {
      grade: document.getElementById("incGrade").value || "",
      salary: document.getElementById("incSalary").value || "",
      rating: document.getElementById("incRating").value || "",
      rateYear: document.getElementById("incRateYear").value || "current",
      promotion: document.getElementById("incPromotion").value || "no"
    },
    saip: {
      grade: document.getElementById("saipGrade").value || "",
      salary: document.getElementById("saipSalary").value || "",
      rating: document.getElementById("saipRating").value || "",
      protected: document.getElementById("saipProtected").value || "no",
      companyFactor: document.getElementById("saipCompanyFactor").value || "1"
    }
  };
  saveState(state);
}

/* =========================
   I18N (Full UI)
========================= */
const I18N = {
  ar: {
    sar: "ريال",
    appTitle: "حاسبة الراتب البسيطة",
    appSubtitle: "حساب سريع في أي ربع راتبك، الزيادة السنوية، و SAIP.",
    rtlLabel: "العربية",
    copyBtn: "نسخ النتيجة",

    tabQuarter: "تحقق من راتبك",
    tabIncrease: "الزيادة السنوية",
    tabSaip: "SAIP",

    t1Title: "تحقق من راتبك في أي ربع",
    t1Badge: "",
    t2Title: "حاسبة الزيادة السنوية",
    t2Badge: "",
    t3Title: "حاسبة مكافأة SAIP",
    t3Badge: "",

    gradeLabel: " الدرجةالوظيفية (GC)",
    salaryLabel: "الراتب",
    currentSalaryLabel: "الراتب الحالي",
    salaryPlaceholder: "مثال: راتبك 25,000",
    salaryHelp: "أرقام فقط (ريال). سيتم تنسيق الرقم تلقائياً أثناء الكتابة.",
    companyFactorPlaceholder: "مثال: 1.0",

    ratingLabel: "تقييم الأداء",
    ratingLabelShort: "التقييم",
    promotionLabel: "ترقية؟",
    protectedLabel: "محمي؟",
    companyFactorLabel: "عامل الشركة",

    /* NEW */
    rateYearLabel: "سنة الزيادة",
    rateYearCurrent: "السنة الحالية",
    rateYearPrevious: "السنة الماضية",
    rateYearUnsure: "مع بعض",

    checkBtn: "تحقق",
    calcBtn: "احسب",
    calcSaipBtn: "احسب SAIP",
    resetBtn: "إعادة ضبط",

    showSalaryTable: "عرض جدول الرواتب",
    toggleSalaryTable: "الجدول",
    showIncreaseTable: "عرض جدول نسب الزيادة السنوية",
    showPromoTable: "عرض جدول نسب الترقية",
    showIncreaseTableMobile: "جدول النسب",
    showPromoTableMobile: "جدول نسب الترقية",
    showFactors: "عرض عوامل SAIP",
    showFactorsMobile: "العوامل",

    thGc: "GC",
    thQ1: "0–25%",
    thQ2: "25–50%",
    thQ3: "50–75%",
    thQ4: "75–100%",
    thRating: "التقييم",
    thQuarter1: "الربع 1",
    thQuarter2: "الربع 2",
    thQuarter3: "الربع 3",
    thQuarter4: "الربع 4",
    thType: "النوع",

    chooseGrade: "اختر الدرجة الوظيفية",
    chooseRating: "اختر التقييم السنوي",
    choose: "اختر",
    yes: "نعم",
    no: "لا",

    rulesTitle: "القواعد (ملخص)",
    rules: [
      "إذا الراتب أكبر من حد الدرجة الأعلى → يتوقف الحساب.",
      "إذا الراتب أقل من الحد الأدنى → مسموح، ويُعامل كـ “ربع أول” لحساب النسبة.",
      "يتم تقريب الزيادات لأقرب رقم ينتهي بـ 0 أو 5.",
      "إذا تجاوزت الزيادة سقف الدرجة (الحالية أو التالية في الترقية) → يُثبت على السقف والباقي يصبح مبلغاً مقطوعاً.",
      "تقييم الربع بعد الزيادة يتم على الدرجة بعد الترقية (إن وجدت)."
    ],

    saipEquationTitle: "معادلة المكافأة",
    saipEquationHtml: `
      <strong>المكافأة = الراتب × عامل الدرجة × عامل التقييم × عامل الشركة</strong><br>
      تقييم <strong>D</strong>: المكافأة = 0 إلا إذا كان الموظف <strong>محمي</strong>.<br>
      إذا كان محمي والمبلغ المحسوب أقل من الحد الأدنى (بعد عامل الشركة) → يتم دفع الحد الأدنى.
    `,

    /* ✅ NEW: Disclaimer (Arabic) */
    disclaimerHtml: `
      <div class="fw-semibold mb-1">إخلاء مسؤولية (لأغراض تعليمية فقط)</div>
      <div>
        هذه الحاسبة أُعدّت لأغراض تعليمية وتجريبية فقط، ولا تُعد مرجعًا رسميًا أو بديلاً عن السياسات والأنظمة المعتمدة لدى جهة العمل أو أي جهة مختصة.
        قد تختلف النتائج الظاهرة عن النتائج الفعلية بسبب اختلاف المعادلات أو تحديثات الأنظمة أو إدخال بيانات غير دقيقة أو فروقات التقريب.
        باستخدامك لهذه الحاسبة، فإنك تقرّ بأن الاعتماد على النتائج يكون على مسؤوليتك الشخصية، وأن مطوّر/مالك الحاسبة لا يتحمل أي مسؤولية عن أي خسائر أو قرارات أو التزامات تنتج عن استخدامها.
        يُنصح بالتحقق من أي نتائج مع الموارد الرسمية أو قسم الموارد البشرية/الجهة المختصة قبل اتخاذ أي إجراء.
      </div>
    `,

    saipGradeRange: "نطاق الدرجة",
    saipGradeFactor: "عامل الدرجة",
    saipRatingFactor: "عامل التقييم",
    saipProtectedFloorTitle: "حد المحمي (فقط عند Rating=D و Protected=Yes)",
    saipFloorFactor: "عامل الحد",
    saipGc610: "GC 6–10",
    saipGc1114: "GC 11–14",
    saipGc15p: "GC 15+",
    saipDNote: "0 (إلا إذا انطبق حد المحمي)",

    accessibilityNote: "سهولة الوصول: النتائج تُعلن لقارئات الشاشة، والمدخلات محسنة للهواتف.",

    copied: "تم النسخ",
    noResult: "لا توجد نتيجة لنسخها بعد.",
    resetDone: "تمت إعادة الضبط",
    switchedAr: "تم تفعيل العربية/RTL",
    switchedEn: "تم تفعيل الإنجليزية/LTR",

    invalidInputs: "أدخل راتب صحيح (>= 0) واختر الدرجة.",
    invalidInputs2: "أدخل راتب صحيح (>= 0)، واختر الدرجة والتقييم.",
    invalidInputs3: "أدخل بيانات صحيحة: الدرجة، الراتب (>=0)، التقييم، عامل الشركة (>=0).",
    invalidGrade: "درجة غير صحيحة (يجب 6–17).",

    salaryAboveMax: (gc,max,entered)=>`
      <strong>غير مسموح:</strong> الراتب أعلى من الحد الأعلى للدرجة.<br>
      حد GC ${gc} الأعلى هو <strong>${sar(max)}</strong>، والراتب المُدخل <strong>${sar(entered)}</strong>.
    `,
    promoNotPossible: (ng)=> `<strong>الترقية غير ممكنة:</strong> الدرجة التالية (GC ${ng}) غير موجودة.`,
    rateNotFound: "لم يتم العثور على نسبة الزيادة لهذه الحالة (التقييم/الربع).",

    belowMin: "أقل من الحد الأدنى",
    treatedQ1: "أقل من الحد الأدنى (يُعامل كربع أول لحساب النسبة)",
    unknownQuarter: "غير معروف",
    min:"الحد الأدنى",
    max:"الحد الأعلى",
    quarterProgression: " تدرج في أي ربع راتبك ",
    passed: "الأرباع المُنجزة",
    gradeRange:"راتب الدرجة",
    current: "الربع الحالي",
    upcoming: "غير مُحقق بعد",
    none: "لا يوجد",
    maxReached: "لا يوجد — وصلت للحد الأعلى",
    increaseFromMin: "الزيادة من الحد الأدنى",
    pctOfRange: "من نطاق الدرجة",
    neededToMax: "المتبقي للوصول للحد الأعلى",

    annualIncrease: "الزيادة السنوية",
    promotion: "الترقية",
    totalIncrease: "إجمالي الزيادة (بعد التقريب)",
    appliedIncrease: "الزيادة المطبقة (حتى حد الدرجة)",
    newSalary: "الراتب بعد الزيادة",
    lumpSum: "المتبقي (مبلغ مقطوع مرة واحدة)",
    quarterBefore: "الربع قبل الزيادة",
    quarterRange: "نطاق الربع",
    quarterAfter: "الربع بعد الزيادة",
    reevalNewGrade: (ng)=> `— إعادة تقييم على الدرجة الجديدة (GC ${ng})`,
    sameQuarter: "— نفس الربع",
    movedQuarter: "— انتقل لربع جديد",
    evaluatedAfter: "— تم التقييم بعد الزيادة",
    gradeProgress: "نسبة التقدم داخل الدرجة (من الأدنى للأعلى)",
    before: "قبل",
    after: "بعد",
    change: "التغير",
    remainingToMax: "المتبقي للوصول للحد الأعلى",
    reducedBy: "انخفض بمقدار",
    cappedMsg: "تم تثبيت الراتب على حد الدرجة الأعلى، والباقي مبلغ مقطوع.",

    saipFormulaTitle: "المعادلة",
    saipFormula: "المكافأة = الراتب × عامل الدرجة × عامل التقييم × عامل الشركة",
    inputsTitle: "المدخلات",
    factorsTitle: "العوامل",
    protectedTitle: "محمي",
    protectedFloorFactor: "عامل حد المحمي",
    protectedFloorAmount: "مبلغ حد المحمي",
    floorApplied: "تم تطبيق الحد؟",
    ratingDNoProtected: "تقييم D: لا يوجد SAIP إلا إذا كان الموظف محمي. تم ضبط المكافأة إلى 0.",
    finalBonus: "المكافأة النهائية",
    breakdown: "تفصيل العملية",

    q1Name: "الربع الأول",
    q2Name: "الربع الثاني",
    q3Name: "الربع الثالث",
    q4Name: "الربع الرابع",
  },

  en: {
    sar: "SAR",
    appTitle: "Simple Salary Calculator",
    appSubtitle: "Simple calculator To check which quarter is your salary, annual increase, and SAIP.",
    rtlLabel: "Arabic",
    copyBtn: "Copy Result",

    tabQuarter: "Check Salary Quarter",
    tabIncrease: "Annual Increase",
    tabSaip: "SAIP",

    t1Title: "Check Your Salary Quarter",
    t1Badge: "",
    t2Title: "Annual Increase Calculator",
    t2Badge: "",
    t3Title: "SAIP Bonus Calculator",
    t3Badge: "",

    gradeLabel: "Grade Code (GC)",
    salaryLabel: "Salary",
    currentSalaryLabel: "Current Salary",
    salaryPlaceholder: "e.g., 25,000",
    salaryHelp: "Numbers only (SAR). Value auto-formats while typing.",
    companyFactorPlaceholder: "e.g., 1.0",

    ratingLabel: "Performance Rating",
    ratingLabelShort: "Rating",
    promotionLabel: "Promotion?",
    protectedLabel: "Protected?",
    companyFactorLabel: "Company Factor",

    /* NEW */
    rateYearLabel: "Rate Year",
    rateYearCurrent: "Current year",
    rateYearPrevious: "Previous year",
    rateYearUnsure: "Both",

    checkBtn: "Check",
    calcBtn: "Calculate",
    calcSaipBtn: "Calculate SAIP",
    resetBtn: "Reset",

    showSalaryTable: "Show Salary Table",
    toggleSalaryTable: "Table",
    showIncreaseTable: "Show Annual Increase Rates",
    showPromoTable: "Show Promotion Rates",
    showIncreaseTableMobile: "Rates",
    showPromoTableMobile: "Promotion Rates",
    showFactors: "Show SAIP Factors",
    showFactorsMobile: "Factors",

    thGc: "GC",
    thQ1: "0–25%",
    thQ2: "25–50%",
    thQ3: "50–75%",
    thQ4: "75–100%",
    thRating: "Rating",
    thQuarter1: "Q1",
    thQuarter2: "Q2",
    thQuarter3: "Q3",
    thQuarter4: "Q4",
    thType: "Type",

    chooseGrade: "Select grade code",
    chooseRating: "Select your rating ",
    choose: "Select",
    yes: "Yes",
    no: "No",

    rulesTitle: "Rules (summary)",
    rules: [
      "If salary is above the grade maximum → calculation stops.",
      "If salary is below the grade minimum → allowed and treated as “Q1” for rate selection.",
      "All increases are rounded to the nearest number ending with 0 or 5.",
      "If increase exceeds the grade cap (current or next grade in promotion) → salary is capped and the rest becomes a one-time lump sum.",
      "Quarter-after evaluation is done on the post-promotion grade (if any)."
    ],

    saipEquationTitle: "Bonus formula",
    saipEquationHtml: `
      <strong>Bonus = Salary × Grade Factor × Rating Factor × Company Factor</strong><br>
      Rating <strong>D</strong>: bonus = 0 unless the employee is <strong>Protected</strong>.<br>
      If Protected and computed bonus is below the minimum (after company factor) → pay the minimum.
    `,

    /* ✅ NEW: Disclaimer (English) */
    disclaimerHtml: `
      <div class="fw-semibold mb-1">Disclaimer (For Educational Purposes Only)</div>
      <div>
        This calculator is provided for educational and experimental purposes only and does not constitute official guidance
        or a substitute for the approved policies and regulations of any employer or competent authority.
        The displayed results may differ from actual outcomes due to formula variations, system updates, inaccurate inputs, or rounding differences.
        By using this calculator, you acknowledge that reliance on the results is at your own risk, and the developer/owner assumes no liability
        for any losses, decisions, or obligations arising from its use.
        Please verify any results with official sources or the relevant HR/competent department before taking any action.
      </div>
    `,

    saipGradeRange: "Grade range",
    saipGradeFactor: "Grade factor",
    saipRatingFactor: "Rating factor",
    saipProtectedFloorTitle: "Protected floor (only when Rating=D and Protected=Yes)",
    saipFloorFactor: "Floor factor",
    saipGc610: "GC 6–10",
    saipGc1114: "GC 11–14",
    saipGc15p: "GC 15+",
    saipDNote: "0 (unless Protected floor applies)",

    accessibilityNote: "Accessibility: results announced to screen readers, inputs optimized for mobile.",

    copied: "Copied",
    noResult: "No result to copy yet.",
    resetDone: "Reset done",
    switchedAr: "Arabic/RTL enabled",
    switchedEn: "English/LTR enabled",

    invalidInputs: "Enter a valid salary (>= 0) and select a grade.",
    invalidInputs2: "Enter a valid salary (>= 0), then select grade and rating.",
    invalidInputs3: "Enter valid inputs: grade, salary (>=0), rating, company factor (>=0).",
    invalidGrade: "Invalid grade (must be 6–17).",

    salaryAboveMax: (gc,max,entered)=>`
      <strong>Not allowed:</strong> salary is above the grade maximum.<br>
      GC ${gc} max is <strong>${sar(max)}</strong>; entered salary is <strong>${sar(entered)}</strong>.
    `,
    promoNotPossible: (ng)=> `<strong>Promotion not possible:</strong> next grade (GC ${ng}) does not exist.`,
    rateNotFound: "No increase rate found for this case (rating/quarter).",

    belowMin: "Below minimum",
    treatedQ1: "Below minimum (treated as Q1 for rate selection)",
    unknownQuarter: "Unknown",
    min:"minimum",
    max:"maximum",
    quarterProgression: "Quarter progression",
    passed: "Completed quarters",
    gradeRange: "Grade Salary Range",
    current: "Current quarter",
    upcoming: "Upcoming",
    none: "None",
    maxReached: "None — at maximum",
    increaseFromMin: "Increase From minimum",
    pctOfRange: "of grade range",
    neededToMax: "Remaining to maximum",

    annualIncrease: "Annual increase",
    promotion: "Promotion",
    totalIncrease: "Total increase (rounded)",
    appliedIncrease: "Applied increase (capped to grade max)",
    newSalary: "New salary",
    lumpSum: "Remaining (one-time lump sum)",
    quarterBefore: "Quarter before",
    quarterRange: "Quarter range",
    quarterAfter: "Quarter after",
    reevalNewGrade: (ng)=> `— re-evaluated on new grade (GC ${ng})`,
    sameQuarter: "— same quarter",
    movedQuarter: "— moved to a new quarter",
    evaluatedAfter: "— evaluated after increase",
    gradeProgress: "Progress within grade (min → max)",
    before: "Before",
    after: "After",
    change: "Change",
    remainingToMax: "Remaining to maximum",
    reducedBy: "Reduced by",
    cappedMsg: "Salary was capped at the grade maximum; the rest becomes a one-time lump sum.",

    saipFormulaTitle: "Formula",
    saipFormula: "Bonus = Salary × Grade Factor × Rating Factor × Company Factor",
    inputsTitle: "Inputs",
    factorsTitle: "Factors",
    protectedTitle: "Protected",
    protectedFloorFactor: "Protected floor factor",
    protectedFloorAmount: "Protected floor amount",
    floorApplied: "Floor applied?",
    ratingDNoProtected: "Rating D: no SAIP unless Protected. Bonus set to 0.",
    finalBonus: "Final bonus",
    breakdown: "Calculation breakdown",

    q1Name: "Quarter 1",
    q2Name: "Quarter 2",
    q3Name: "Quarter 3",
    q4Name: "Quarter 4",
  }
};

function t(key, ...args){
  const lang = document.documentElement.lang || "ar";
  const dict = I18N[lang] || I18N.ar;
  const v = dict[key];
  return (typeof v === "function") ? v(...args) : (v ?? key);
}

/* Apply translations to all tagged nodes */
function applyTranslations(){
  const lang = document.documentElement.lang || "ar";
  const dict = I18N[lang] || I18N.ar;

  document.querySelectorAll("[data-i18n]").forEach(el=>{
    const key = el.getAttribute("data-i18n");
    const v = dict[key];
    if(v == null) return;
    el.textContent = (typeof v === "function") ? v() : v;
  });

  document.querySelectorAll("[data-i18n-placeholder]").forEach(el=>{
    const key = el.getAttribute("data-i18n-placeholder");
    const v = dict[key];
    if(v == null) return;
    el.setAttribute("placeholder", (typeof v === "function") ? v() : v);
  });

  /* ✅ NEW: allow HTML translations */
  document.querySelectorAll("[data-i18n-html]").forEach(el=>{
    const key = el.getAttribute("data-i18n-html");
    const v = dict[key];
    if(v == null) return;
    el.innerHTML = (typeof v === "function") ? v() : v;
  });

  // Rules list
  const ul = document.getElementById("rulesList");
  ul.innerHTML = "";
  (dict.rules || []).forEach(line=>{
    const li = document.createElement("li");
    li.textContent = line;
    ul.appendChild(li);
  });

  // SAIP equation
  document.getElementById("saipEquationText").innerHTML = dict.saipEquationHtml || "";
}

/* =========================
   Select builders (fully bilingual)
========================= */
function buildGradeSelect(selectId, from=6, to=17){
  const sel = document.getElementById(selectId);
  const current = sel.value;

  sel.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.disabled = true;
  ph.selected = true;
  ph.textContent = t("chooseGrade");
  sel.appendChild(ph);

  for(let g=from; g<=to; g++){
    const opt = document.createElement("option");
    opt.value = String(g);
    opt.textContent = String(g);
    sel.appendChild(opt);
  }

  if(current){
    sel.value = current;
    if(sel.value !== current) sel.selectedIndex = 0;
  }
}

function buildRatingSelect(selectId, includeD=false){
  const sel = document.getElementById(selectId);
  const current = sel.value;

  sel.innerHTML = "";
  const ph = document.createElement("option");
  ph.value = "";
  ph.disabled = true;
  ph.selected = true;
  ph.textContent = t("chooseRating");
  sel.appendChild(ph);

  const list = includeD ? ["S","E+","E","M","D"] : ["S","E+","E","M"];
  list.forEach(v=>{
    const opt = document.createElement("option");
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  });

  if(current){
    sel.value = current;
    if(sel.value !== current) sel.selectedIndex = 0;
  }
}

function buildYesNoSelect(selectId, defaultVal="no"){
  const sel = document.getElementById(selectId);
  const current = sel.value || defaultVal;

  sel.innerHTML = "";
  const optNo = document.createElement("option");
  optNo.value = "no";
  optNo.textContent = t("no");

  const optYes = document.createElement("option");
  optYes.value = "yes";
  optYes.textContent = t("yes");

  sel.appendChild(optNo);
  sel.appendChild(optYes);

  sel.value = current;
  if(sel.value !== current) sel.value = defaultVal;
}

/* NEW: rate year select */
function buildRateYearSelect(selectId){
  const sel = document.getElementById(selectId);
  const current = sel.value || "current";

  sel.innerHTML = "";

  const optCurrent = document.createElement("option");
  optCurrent.value = "current";
  optCurrent.textContent = t("rateYearCurrent");

  const optPrevious = document.createElement("option");
  optPrevious.value = "previous";
  optPrevious.textContent = t("rateYearPrevious");

  const optUnsure = document.createElement("option");
  optUnsure.value = "unsure";
  optUnsure.textContent = t("rateYearUnsure");

  sel.appendChild(optCurrent);
  sel.appendChild(optPrevious);
  sel.appendChild(optUnsure);

  sel.value = current;
}

function rebuildAllSelects(){
  buildGradeSelect("grade", 6, 17);
  buildGradeSelect("incGrade", 6, 17);
  buildGradeSelect("saipGrade", 6, 17);

  buildRatingSelect("incRating", false);
  buildRatingSelect("saipRating", true);

  buildRateYearSelect("incRateYear");

  buildYesNoSelect("incPromotion", "no");
  buildYesNoSelect("saipProtected", "no");
}

/* =========================
   Quarter detection (safe)
========================= */
function detectQuarter(gradeStr, enteredSalary){
  const band = salaryBands[gradeStr];
  if(!band) return { ok:false, error:t("invalidGrade") };

  if (enteredSalary < band.min){
    return { ok:false, band, quarterIndex:-1, quarterName:t("belowMin") };
  }

  const idx = band.quarters.findIndex(q => enteredSalary >= q.min && enteredSalary <= q.max);
  const quarterName = (idx >= 0)
    ? [t("q1Name"), t("q2Name"), t("q3Name"), t("q4Name")][idx]
    : t("unknownQuarter");

  return { ok:true, band, quarterIndex: idx, quarterName };
}

/* =========================
   SAIP FACTORS
========================= */
function getSaipGradeFactor(gc){
  if(gc >= 6 && gc <= 10) return 1.5;
  if(gc >= 11 && gc <= 14) return 1.8;
  if(gc >= 15) return 2.4;
  return null;
}
function getSaipRatingFactor(r){
  if(r === "S") return 1.5;
  if(r === "E+") return 1.25;
  if(r === "E") return 1.0;
  if(r === "M") return 0.75;
  if(r === "D") return 0.0;
  return null;
}
function getProtectedFloorFactor(gc){
  if(gc >= 6 && gc <= 10) return 1.0;
  if(gc >= 11 && gc <= 14) return 1.6;
  if(gc >= 15) return 2.0;
  return null;
}

/* =========================
   INIT UI
========================= */
wireMoneyInput("salaryDisplay","salary", persistAllInputs);
wireMoneyInput("incSalaryDisplay","incSalary", persistAllInputs);
wireMoneyInput("saipSalaryDisplay","saipSalary", persistAllInputs);

["grade","incGrade","incSalaryDisplay","incRating","incRateYear","incPromotion","saipGrade","saipRating","saipProtected","saipCompanyFactor"].forEach(id=>{
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener("change", persistAllInputs);
  el.addEventListener("input", persistAllInputs);
});

/* Salary table (static ranges, bilingual headers handled by i18n) */
Object.keys(salaryBands).sort((a,b)=>+a-+b).forEach(gc=>{
  const q = salaryBands[gc].quarters;
  document.getElementById("salaryTableBody").innerHTML += `
    <tr>
      <td>${gc}</td>
      <td>${fmt(q[0].min)} – ${fmt(q[0].max)}</td>
      <td>${fmt(q[1].min)} – ${fmt(q[1].max)}</td>
      <td>${fmt(q[2].min)} – ${fmt(q[2].max)}</td>
      <td>${fmt(q[3].min)} – ${fmt(q[3].max)}</td>
    </tr>
  `;
});

/* Annual increase table */
function renderIncreaseTables(){
  const yearKey = document.getElementById("incRateYear")?.value || "current";
  const rates = increaseRatesByYear[yearKey === "previous" ? "previous" : "current"];

  document.getElementById("increaseTableBody").innerHTML = "";
  ["S","E+","E","M"].forEach(key=>{
    const r = rates[key];
    document.getElementById("increaseTableBody").innerHTML += `
      <tr>
        <td>${key}</td>
        <td>${fmtPct(r.q1)}</td>
        <td>${fmtPct(r.q2)}</td>
        <td>${fmtPct(r.q3)}</td>
        <td>${fmtPct(r.q4)}</td>
      </tr>
    `;
  });

  document.getElementById("promoTableBody").innerHTML = `
    <tr>
      <td>${t("promotion")}</td>
      <td>${fmtPct(promotionRates.q1)}</td>
      <td>${fmtPct(promotionRates.q2)}</td>
      <td>${fmtPct(promotionRates.q3)}</td>
      <td>${fmtPct(promotionRates.q4)}</td>
    </tr>
  `;
}

/* =========================
   Restore saved state (after selects are built)
========================= */
function restoreFromState(){
  const s = loadState();
  const rtl = (s.rtl !== undefined) ? !!s.rtl : true;
  applyRTL(rtl, false);
  document.getElementById("rtlToggle").checked = rtl;

  if(s.checker){
    if(s.checker.grade) document.getElementById("grade").value = s.checker.grade;
    const n = Number(s.checker.salary);
    setMoneyInput("salaryDisplay","salary", Number.isFinite(n) ? n : NaN);
  }

  if(s.increase){
    if(s.increase.grade) document.getElementById("incGrade").value = s.increase.grade;
    const n = Number(s.increase.salary);
    setMoneyInput("incSalaryDisplay","incSalary", Number.isFinite(n) ? n : NaN);
    if(s.increase.rating) document.getElementById("incRating").value = s.increase.rating;
    if(s.increase.rateYear) document.getElementById("incRateYear").value = s.increase.rateYear;
    if(s.increase.promotion) document.getElementById("incPromotion").value = s.increase.promotion;
  }

  if(s.saip){
    if(s.saip.grade) document.getElementById("saipGrade").value = s.saip.grade;
    const n = Number(s.saip.salary);
    setMoneyInput("saipSalaryDisplay","saipSalary", Number.isFinite(n) ? n : NaN);
    if(s.saip.rating) document.getElementById("saipRating").value = s.saip.rating;
    if(s.saip.protected) document.getElementById("saipProtected").value = s.saip.protected;
    if(s.saip.companyFactor) document.getElementById("saipCompanyFactor").value = s.saip.companyFactor;
  }
}

/* =========================
   Refresh visible results after language switch
========================= */
function refreshVisibleResultsAfterLangSwitch(){
  const r1 = document.getElementById("result");
  const r2 = document.getElementById("incResult");
  const r3 = document.getElementById("saipResult");

  if(r1 && !r1.classList.contains("d-none") && r1.innerHTML.trim()) runQuarterCheck();
  if(r2 && !r2.classList.contains("d-none") && r2.innerHTML.trim()) runIncreaseCalc();
  if(r3 && !r3.classList.contains("d-none") && r3.innerHTML.trim()) runSaipCalc();
}

/* =========================
   RTL + Language toggle
========================= */
function applyRTL(isRTL, showToast=true){
  document.documentElement.dir = isRTL ? "rtl" : "ltr";
  document.documentElement.lang = isRTL ? "ar" : "en";

  applyTranslations();
  rebuildAllSelects();

  renderIncreaseTables();
  refreshVisibleResultsAfterLangSwitch();

  if(showToast){
    toast(isRTL ? t("switchedAr") : t("switchedEn"));
  }
  persistAllInputs();
}

/* First run */
applyTranslations();
rebuildAllSelects();
restoreFromState();
renderIncreaseTables();

/* re-render rates table when rate year changes */
document.getElementById("incRateYear").addEventListener("change", ()=>{
  renderIncreaseTables();
  persistAllInputs();
});

/* =========================
   TAB 1: QUARTER CHECKER
========================= */
function runQuarterCheck(){
  const grade = document.getElementById("grade").value;
  const enteredSalary = readNumberFromHidden("salary");

  if(!grade || !Number.isFinite(enteredSalary) || enteredSalary < 0){
    return show("result","warning", t("invalidInputs"));
  }

  const band = salaryBands[grade];
  if(!band) return show("result","danger", t("invalidGrade"));

  if(enteredSalary > band.max){
    return show("result","danger", t("salaryAboveMax", grade, band.max, enteredSalary));
  }

  const range = band.max - band.min;

  let idx = -1;
  let currentName = t("belowMin");

  if (enteredSalary >= band.min){
    idx = band.quarters.findIndex(q => enteredSalary >= q.min && enteredSalary <= q.max);
    currentName = (idx >= 0)
      ? [t("q1Name"), t("q2Name"), t("q3Name"), t("q4Name")][idx]
      : t("unknownQuarter");
  }

  const passed = (idx <= 0)
    ? badge(t("none"), "secondary")
    : [t("q1Name"),t("q2Name"),t("q3Name"),t("q4Name")].slice(0, idx).map(q => badge(q, "success")).join("");

  const currentBadge = badge(
    `${currentName} (${t("current")})`,
    idx === -1 ? "warning" : "primary"
  );

  const upcoming = (idx === -1)
    ? [t("q1Name"),t("q2Name"),t("q3Name"),t("q4Name")].map(q => badge(q, "secondary")).join("")
    : ([t("q1Name"),t("q2Name"),t("q3Name"),t("q4Name")].slice(idx+1).map(q => badge(q, "secondary")).join("") || badge(t("maxReached"), "dark"));

  const increaseFromMin = enteredSalary - band.min;
  const percentFromMin = ((enteredSalary - band.min) / range) * 100;

  const neededToMax = Math.max(0, band.max - enteredSalary);
  const percentToMax = (neededToMax / range) * 100;

  show("result","success", `
    <strong>${t("quarterProgression")}</strong><br><br>
    <strong>✔ ${t("gradeRange")}:</strong>(<b>${t("min")}:</b>${band.min} - <b>${t("max")}:</b>${ band.max})<br><br>
    <strong>✔ ${t("passed")}:</strong><br>${passed}<br><br>
    <strong>📍 ${t("current")}:</strong><br>${currentBadge}<br><br>
    <strong>🎯 ${t("upcoming")}:</strong><br>${upcoming}<br><br>

    <hr class="my-2">

    <strong>${t("increaseFromMin")}:</strong> ${sar(increaseFromMin)}
    (<strong>${percentFromMin.toFixed(2)}%</strong> ${t("pctOfRange")})<br>

    <strong>${t("neededToMax")}:</strong> ${sar(neededToMax)}
    (<strong>${percentToMax.toFixed(2)}%</strong> ${t("pctOfRange")})
  `);

  persistAllInputs();
}

document.getElementById("checkBtn").onclick = runQuarterCheck;
document.getElementById("checkBtnMobile").onclick = runQuarterCheck;

function resetChecker(){
  document.getElementById("grade").value = "";
  setMoneyInput("salaryDisplay","salary", NaN);
  hide("result");
  persistAllInputs();
  toast(t("resetDone"));
}
document.getElementById("resetChecker").onclick = resetChecker;
document.getElementById("resetCheckerMobile").onclick = resetChecker;

/* =========================
   TAB 2: ANNUAL INCREASE + PROMOTION
========================= */
function runIncreaseCalc(){
  const gradeStr = document.getElementById("incGrade").value;
  const grade = Number(gradeStr);
  const salary = readNumberFromHidden("incSalary");
  const rating = document.getElementById("incRating").value;
  const promotion = document.getElementById("incPromotion").value;

  if(!gradeStr || !Number.isFinite(salary) || salary < 0 || !rating){
    return show("incResult","warning", t("invalidInputs2"));
  }

  const currentBand = salaryBands[String(grade)];
  if(!currentBand) return show("incResult","danger", t("invalidGrade"));

  if(salary > currentBand.max){
    return show("incResult","danger", t("salaryAboveMax", grade, currentBand.max, salary));
  }

  const qBefore = detectQuarter(String(grade), salary);

  let quarterKey = "q1";
  let qBeforeLabel = t("treatedQ1");
  let beforeRangeText = `${sar(currentBand.min)} – ${sar(currentBand.max)}`;

  if(qBefore.ok && qBefore.quarterIndex >= 0){
    quarterKey = ["q1","q2","q3","q4"][qBefore.quarterIndex];
    qBeforeLabel = qBefore.quarterName;
    const beforeRange = currentBand.quarters[qBefore.quarterIndex];
    beforeRangeText = `${sar(beforeRange.min)} – ${sar(beforeRange.max)}`;
  }

  const yearChoice = document.getElementById("incRateYear").value || "current";

  function calcWithRates(rates){
    const annualRate = rates[rating]?.[quarterKey];
    if(annualRate == null) return { ok:false, err:t("rateNotFound") };

    const annualRaw = salary * annualRate;
    const annualRounded = roundTo5(annualRaw);

    let promoRate = 0, promoRaw = 0, promoRounded = 0;
    let newGrade = grade;
    let capBand = currentBand;

    if(promotion === "yes"){
      newGrade = grade + 1;
      const nextBand = salaryBands[String(newGrade)];
      if(!nextBand) return { ok:false, err:t("promoNotPossible", newGrade) };
      promoRate = promotionRates[quarterKey] ?? 0;
      promoRaw = salary * promoRate;
      promoRounded = roundTo5(promoRaw);
      capBand = nextBand;
    }

    const totalRounded = promoRounded + annualRounded;

    const headroomToMax = capBand.max - salary;
    const appliedIncrease = Math.min(totalRounded, headroomToMax);
    const newSalary = salary + appliedIncrease;
    const remainingLumpSum = Math.max(0, totalRounded - appliedIncrease);

    return {
      ok:true,
      annualRate, annualRaw, annualRounded,
      promoRate, promoRaw, promoRounded,
      totalRounded, appliedIncrease, newSalary, remainingLumpSum,
      newGrade, capBand
    };
  }

  const ratesCurrent = increaseRatesByYear.current;
  const ratesPrevious = increaseRatesByYear.previous;

  const scenarios = [];
  if(yearChoice === "unsure"){
    scenarios.push({ key:"current", label:t("rateYearCurrent"), result: calcWithRates(ratesCurrent) });
    scenarios.push({ key:"previous", label:t("rateYearPrevious"), result: calcWithRates(ratesPrevious) });
  } else if(yearChoice === "previous"){
    scenarios.push({ key:"previous", label:t("rateYearPrevious"), result: calcWithRates(ratesPrevious) });
  } else {
    scenarios.push({ key:"current", label:t("rateYearCurrent"), result: calcWithRates(ratesCurrent) });
  }

  for(const sc of scenarios){
    if(!sc.result.ok){
      return show("incResult","danger", sc.result.err);
    }
  }

  const blocksHtml = scenarios.map(sc=>{
    const r = sc.result;

    const qAfter = detectQuarter(String(r.newGrade), r.newSalary);

    let afterRangeText = "—";
    let afterQuarterName = t("unknownQuarter");
    let movedText = "";

    if(qAfter.ok && qAfter.quarterIndex >= 0){
      afterQuarterName = qAfter.quarterName;
      const afterBand = salaryBands[String(r.newGrade)];
      const afterRange = afterBand.quarters[qAfter.quarterIndex];
      afterRangeText = `${sar(afterRange.min)} – ${sar(afterRange.max)}`;

      if(promotion === "yes"){
        movedText = `<span class="text-primary">${t("reevalNewGrade", r.newGrade)}</span>`;
      } else if(qBefore.ok && qBefore.quarterIndex >= 0) {
        movedText = (qAfter.quarterIndex === qBefore.quarterIndex)
          ? `<span class="text-success">${t("sameQuarter")}</span>`
          : `<span class="text-primary">${t("movedQuarter")}</span>`;
      } else {
        movedText = `<span class="text-primary">${t("evaluatedAfter")}</span>`;
      }
    }

    const range = r.capBand.max - r.capBand.min;
    const progressBefore = clamp01((salary - r.capBand.min) / range) * 100;
    const progressAfter  = clamp01((r.newSalary - r.capBand.min) / range) * 100;
    const progressDelta  = progressAfter - progressBefore;

    const remainingBefore = Math.max(0, r.capBand.max - salary);
    const remainingAfter  = Math.max(0, r.capBand.max - r.newSalary);
    const remainingDelta  = remainingBefore - remainingAfter;

    const cappedMsg = r.remainingLumpSum > 0
      ? `<div class="mb-2 text-warning"><strong>${t("cappedMsg")}</strong></div>`
      : "";

    const promoSection = (promotion === "yes")
      ? `
        <div class="mt-2">
          <strong>${t("promotion")} (GC ${grade} → GC ${r.newGrade}):</strong><br>
          ${t("thType")}: <strong>${t("promotion")}</strong><br>
          ${t("change")}: <strong>${fmtPct(r.promoRate)}</strong><br>
          ${t("before")}: <strong>${sar(r.promoRaw)}</strong><br>
          ${t("after")} (0/5): <strong>${sar(r.promoRounded)}</strong>
        </div>
      `
      : `<div class="mt-2"><strong>${t("promotion")}:</strong> ${t("no")}</div>`;

    return `
      <div class="p-3 border rounded-3 mb-3 bg-white">
        <div class="fw-semibold mb-2">${t("rateYearLabel")}: ${sc.label}</div>

        ${cappedMsg}

        <div class="mb-2">
          <strong>${t("gradeLabel")}:</strong> GC ${grade}<br>
          <strong>${t("quarterBefore")}:</strong> ${qBeforeLabel}<br>
          <strong>${t("quarterRange")} (GC ${grade}):</strong> ${beforeRangeText}<br>
        </div>

        <div class="mb-2">
          <strong>${t("annualIncrease")}:</strong><br>
          ${t("thRating")}: <strong>${rating}</strong><br>
          ${t("change")}: <strong>${fmtPct(r.annualRate)}</strong><br>
          ${t("before")}: <strong>${sar(r.annualRaw)}</strong><br>
          ${t("after")} (0/5): <strong>${sar(r.annualRounded)}</strong>
        </div>

        ${promoSection}

        <hr class="my-2">

        <div class="mb-2">
          <strong>${t("totalIncrease")}:</strong> ${sar(r.totalRounded)}<br>
          <strong>${t("appliedIncrease")} (GC ${r.newGrade}):</strong> ${sar(r.appliedIncrease)}<br>
          <strong>${t("newSalary")}:</strong> ${sar(r.newSalary)}<br>
          <strong>${t("lumpSum")}:</strong> ${sar(r.remainingLumpSum)}
        </div>

        <div class="mt-2">
          <strong>${t("quarterAfter")} (GC ${r.newGrade}):</strong> ${afterQuarterName} ${movedText}<br>
          <strong>${t("quarterRange")} (GC ${r.newGrade}):</strong> ${afterRangeText}
        </div>

        <div class="mt-3">
          <strong>${t("gradeProgress")} (GC ${r.newGrade}):</strong><br>
          ${t("before")}: <strong>${progressBefore.toFixed(2)}%</strong> &nbsp;|&nbsp;
          ${t("after")}: <strong>${progressAfter.toFixed(2)}%</strong> &nbsp;|&nbsp;
          ${t("change")}: <strong>${progressDelta.toFixed(2)}%</strong>
        </div>

        <div class="mt-2">
          <strong>${t("remainingToMax")} (GC ${r.newGrade}):</strong><br>
          ${t("before")}: <strong>${sar(remainingBefore)}</strong> &nbsp;|&nbsp;
          ${t("after")}: <strong>${sar(remainingAfter)}</strong> &nbsp;|&nbsp;
          ${t("reducedBy")}: <strong>${sar(remainingDelta)}</strong>
        </div>
      </div>
    `;
  }).join("");

  show("incResult","success", blocksHtml);
  persistAllInputs();
}

document.getElementById("calcIncreaseBtn").onclick = runIncreaseCalc;
document.getElementById("calcIncreaseBtnMobile").onclick = runIncreaseCalc;

function resetIncrease(){
  document.getElementById("incGrade").value = "";
  setMoneyInput("incSalaryDisplay","incSalary", NaN);
  document.getElementById("incRating").value = "";
  document.getElementById("incRateYear").value = "current";
  document.getElementById("incPromotion").value = "no";
  hide("incResult");
  renderIncreaseTables();
  persistAllInputs();
  toast(t("resetDone"));
}
document.getElementById("resetIncrease").onclick = resetIncrease;
document.getElementById("resetIncreaseMobile").onclick = resetIncrease;

/* =========================
   TAB 3: SAIP
========================= */
function runSaipCalc(){
  const gradeStr = document.getElementById("saipGrade").value;
  const gc = Number(gradeStr);
  const salary = readNumberFromHidden("saipSalary");
  const rating = document.getElementById("saipRating").value;
  const isProtected = document.getElementById("saipProtected").value === "yes";
  const companyFactor = Number(document.getElementById("saipCompanyFactor").value);

  if(!gradeStr || !Number.isFinite(salary) || salary < 0 || !rating || !Number.isFinite(companyFactor) || companyFactor < 0){
    return show("saipResult","warning", t("invalidInputs3"));
  }

  const band = salaryBands[String(gc)];
  if(!band){
    return show("saipResult","danger", t("invalidGrade"));
  }

  if(salary > band.max){
    return show("saipResult","danger", t("salaryAboveMax", gc, band.max, salary));
  }

  const gradeFactor = getSaipGradeFactor(gc);
  const ratingFactor = getSaipRatingFactor(rating);

  if(gradeFactor == null) return show("saipResult","danger", t("invalidGrade"));
  if(ratingFactor == null) return show("saipResult","danger", t("chooseRating"));

  const computed = salary * gradeFactor * ratingFactor * companyFactor;

  let floorFactor = null;
  let floorAmount = 0;
  let finalAmount = computed;
  let floorApplied = false;

  if(rating === "D"){
    if(!isProtected){
      finalAmount = 0;
    } else {
      floorFactor = getProtectedFloorFactor(gc);
      if(floorFactor == null){
        return show("saipResult","danger", t("invalidGrade"));
      }
      floorAmount = salary * floorFactor * companyFactor;
      if(computed < floorAmount){
        finalAmount = floorAmount;
        floorApplied = true;
      } else {
        finalAmount = computed;
      }
    }
  }

  const msgD = (rating === "D" && !isProtected)
    ? `<div class="text-warning mb-2"><strong>${t("ratingDNoProtected")}</strong></div>`
    : "";

  const msgFloor = (rating === "D" && isProtected)
    ? `<div class="mb-2">
         <strong>${t("protectedTitle")}:</strong> ${t("yes")}<br>
         <strong>${t("protectedFloorFactor")}:</strong> ${floorFactor}<br>
         <strong>${t("protectedFloorAmount")}:</strong> ${sar(floorAmount)}<br>
         <strong>${t("floorApplied")}</strong> ${floorApplied ? `<span class="text-success">${t("yes")}</span>` : `<span class="text-secondary">${t("no")}</span>`}
       </div>`
    : `<div class="mb-2"><strong>${t("protectedTitle")}:</strong> ${isProtected ? t("yes") : t("no")}</div>`;

  show("saipResult","success", `
    ${msgD}

    <div class="mb-2">
      <strong>${t("saipFormulaTitle")}</strong><br>
      <strong>${t("saipFormula")}</strong>
    </div>

    <div class="mb-2">
      <strong>${t("inputsTitle")}</strong><br>
      ${t("gradeLabel")}: <strong>${gc}</strong><br>
      ${t("salaryLabel")}: <strong>${sar(salary)}</strong><br>
      ${t("ratingLabelShort")}: <strong>${rating}</strong><br>
      ${t("companyFactorLabel")}: <strong>${companyFactor}</strong>
    </div>

    <div class="mb-2">
      <strong>${t("factorsTitle")}</strong><br>
      ${t("saipGradeFactor")}: <strong>${gradeFactor}</strong><br>
      ${t("saipRatingFactor")}: <strong>${ratingFactor}</strong>
    </div>

    ${msgFloor}

    <hr class="my-2">

    <div class="mb-2">
      <strong>${t("breakdown")}:</strong>
      ${sar(salary)} × ${gradeFactor} × ${ratingFactor} × ${companyFactor}
      <br><strong>${t("finalBonus")}:</strong> ${sar(finalAmount)}
    </div>
  `);

  persistAllInputs();
}

document.getElementById("saipCalcBtn").onclick = runSaipCalc;
document.getElementById("saipCalcBtnMobile").onclick = runSaipCalc;

function resetSaip(){
  document.getElementById("saipGrade").value = "";
  setMoneyInput("saipSalaryDisplay","saipSalary", NaN);
  document.getElementById("saipRating").value = "";
  document.getElementById("saipProtected").value = "no";
  document.getElementById("saipCompanyFactor").value = "1";
  hide("saipResult");
  persistAllInputs();
  toast(t("resetDone"));
}
document.getElementById("resetSaip").onclick = resetSaip;
document.getElementById("resetSaipMobile").onclick = resetSaip;

/* =========================
   Copy result (active tab) - bilingual-ready
========================= */
function stripHtmlToText(html){
  const tmp = document.createElement("div");
  tmp.innerHTML = html;
  tmp.querySelectorAll("br").forEach(br => br.replaceWith("\n"));
  tmp.querySelectorAll("li").forEach(li => li.textContent = `• ${li.textContent}`);
  return tmp.textContent.replace(/\n{3,}/g, "\n\n").trim();
}

async function copyActiveResult(){
  const active = document.querySelector(".tab-pane.active.show");
  if(!active) return;

  let resultEl = null;
  if(active.id === "checker") resultEl = document.getElementById("result");
  if(active.id === "increase") resultEl = document.getElementById("incResult");
  if(active.id === "saip") resultEl = document.getElementById("saipResult");

  if(!resultEl || resultEl.classList.contains("d-none") || !resultEl.innerHTML.trim()){
    toast(t("noResult"));
    return;
  }

  const text = stripHtmlToText(resultEl.innerHTML);

  try{
    await navigator.clipboard.writeText(text);
    toast(t("copied"));
  }catch{
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position = "fixed";
    ta.style.top = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast(t("copied"));
  }
}

document.getElementById("copyActiveBtn").addEventListener("click", copyActiveResult);

/* =========================
   Enter submits active tab
========================= */
document.addEventListener("keydown", (e)=>{
  if(e.key !== "Enter") return;

  const active = document.querySelector(".tab-pane.active.show");
  if(!active) return;

  const tag = (e.target?.tagName || "").toLowerCase();
  if(tag === "textarea") return;

  if(active.id === "checker") runQuarterCheck();
  if(active.id === "increase") runIncreaseCalc();
  if(active.id === "saip") runSaipCalc();
});

/* =========================
   RTL toggle
========================= */
document.getElementById("rtlToggle").addEventListener("change", (e)=>{
  applyRTL(e.target.checked, true);
});

/* Persist on tab switch */
document.getElementById("salaryTabs").addEventListener("shown.bs.tab", persistAllInputs);
</script>
</body>
</html>
